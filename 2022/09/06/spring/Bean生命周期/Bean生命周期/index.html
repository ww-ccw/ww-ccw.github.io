

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="chw">
  <meta name="keywords" content="技术博客">
  
    <meta name="description" content="Spring Bean注入的源码分析">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Bean注入详解">
<meta property="og:url" content="https://ww-ccw.github.io/2022/09/06/spring/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/index.html">
<meta property="og:site_name" content="CHW的博客">
<meta property="og:description" content="Spring Bean注入的源码分析">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ww-ccw.github.io/2022/09/06/spring/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/20201212215421213.png">
<meta property="og:image" content="https://ww-ccw.github.io/2022/09/06/spring/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/20201212215520379.png">
<meta property="article:published_time" content="2022-09-05T16:00:00.000Z">
<meta property="article:modified_time" content="2023-04-09T02:01:28.496Z">
<meta property="article:author" content="chw">
<meta property="article:tag" content="源码">
<meta property="article:tag" content="Spring">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://ww-ccw.github.io/2022/09/06/spring/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/20201212215421213.png">
  
  
  
  <title>Spring Bean注入详解 - CHW的博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"ww-ccw.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>CHW的博客</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Spring Bean注入详解"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-09-06 00:00" pubdate>
          2022年9月6日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          18k 字
        
      </span>
    

    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Spring Bean注入详解</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="一、步骤"><a href="#一、步骤" class="headerlink" title="一、步骤"></a>一、步骤</h2><ol>
<li><p>起步</p>
 <div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Application</span>
&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;
        <span class="hljs-comment">//1、读取配置文件</span>
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">&quot;Application.xml&quot;</span>);
        <span class="hljs-comment">//得到bean</span>
        <span class="hljs-type">A</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> context.getBean(<span class="hljs-string">&quot;a&quot;</span>, A.class);
        <span class="hljs-type">B</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> context.getBean(<span class="hljs-string">&quot;b&quot;</span>, B.class);
    &#125;
&#125;</code></pre></div>
</li>
<li><p>对象初始化，略过</p>
</li>
<li><p>读取并解析XML文件</p>
 <div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ClassPathXmlApplicationContext</span><span class="hljs-params">(</span>
<span class="hljs-params">    String[] configLocations, <span class="hljs-type">boolean</span> refresh, <span class="hljs-meta">@Nullable</span> ApplicationContext parent)</span>
    <span class="hljs-keyword">throws</span> BeansException &#123;

    <span class="hljs-built_in">super</span>(parent);
    setConfigLocations(configLocations);
    <span class="hljs-keyword">if</span> (refresh) &#123;
        <span class="hljs-comment">//3、refresh()读取xml初始化</span>
        refresh();
    &#125;
&#125;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AbstractApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DefaultResourceLoader</span>
    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ConfigurableApplicationContext</span> &#123;
    <span class="hljs-comment">//4、读取并解析xml</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException &#123;
        <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.startupShutdownMonitor) &#123;
            <span class="hljs-comment">//准备上下文</span>
            prepareRefresh();
            <span class="hljs-comment">// 告诉子类刷新内部 bean 工厂。</span>
            <span class="hljs-type">ConfigurableListableBeanFactory</span> <span class="hljs-variable">beanFactory</span> <span class="hljs-operator">=</span> obtainFreshBeanFactory();
            <span class="hljs-comment">// 准备 bean 工厂以在此上下文中使用。</span>
            prepareBeanFactory(beanFactory);

            <span class="hljs-keyword">try</span> &#123;
                <span class="hljs-comment">// 允许在上下文子类中对 bean 工厂进行后处理。</span>
                postProcessBeanFactory(beanFactory);
                <span class="hljs-comment">// 调用在上下文中注册为 bean 的工厂处理器。</span>
                invokeBeanFactoryPostProcessors(beanFactory);
                <span class="hljs-comment">// 注册拦截 bean 创建的 bean 处理器。</span>
                registerBeanPostProcessors(beanFactory);
                <span class="hljs-comment">// 为此上下文初始化消息源。</span>
                initMessageSource();
                <span class="hljs-comment">// 为此上下文初始化事件多播器。</span>
                initApplicationEventMulticaster();
                <span class="hljs-comment">// 初始化特定上下文子类中的其他特殊 bean。</span>
                onRefresh();
                <span class="hljs-comment">// 检查侦听器 bean 并注册它们。</span>
                registerListeners();
                <span class="hljs-comment">// 实例化所有剩余的（非惰性初始化）单例。</span>
                finishBeanFactoryInitialization(beanFactory);						<span class="hljs-comment">//  5、初始化beanFactory</span>
                <span class="hljs-comment">// 最后一步：发布相应的事件。</span>
                finishRefresh();
            &#125;

            <span class="hljs-keyword">catch</span> (BeansException ex) &#123;
                <span class="hljs-keyword">if</span> (logger.isWarnEnabled()) &#123;
                    logger.warn(<span class="hljs-string">&quot;Exception encountered during context initialization - &quot;</span> +
                                <span class="hljs-string">&quot;cancelling refresh attempt: &quot;</span> + ex);
                &#125;
                <span class="hljs-comment">// 销毁已经创建的单例以避免悬空资源。</span>
                destroyBeans();
                <span class="hljs-comment">// Reset &#x27;active&#x27; flag.重置“活动”标志。</span>
                cancelRefresh(ex);
                <span class="hljs-comment">// 将异常传播给调用者。</span>
                <span class="hljs-keyword">throw</span> ex;
            &#125;
            <span class="hljs-keyword">finally</span> &#123;
                <span class="hljs-comment">// 重置 Spring 核心中常见的自省缓存，</span>
                <span class="hljs-comment">// 因为我们可能不再需要单例 bean 的元数据了......</span>
                resetCommonCaches();
            &#125;
        &#125;
    &#125;
&#125;</code></pre></div>
</li>
<li><p>初始化BeanFactory,最后调用方法进行bean的实例化</p>
 <div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-comment">//6、初始化BeanFactory，并初始化单例Bean</span>
<span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">finishBeanFactoryInitialization</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;
    <span class="hljs-comment">// 为此上下文初始化转换服务。</span>
    <span class="hljs-keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;
        beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;
        beanFactory.setConversionService(
            beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));
    &#125;
    <span class="hljs-comment">// 如果之前没有注册过任何 bean 后处理器（例如 PropertyPlaceholderConfigurer bean），</span>
    <span class="hljs-comment">// 则注册一个默认的嵌入值解析器：此时，主要用于解析注释属性值。</span>
    <span class="hljs-keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;
        beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));
    &#125;
    <span class="hljs-comment">// 尽早初始化 LoadTimeWeaverAware bean，以便尽早注册它们的转换器。</span>
    String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);
    <span class="hljs-keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;
        getBean(weaverAwareName);
    &#125;
    <span class="hljs-comment">// 停止使用临时 ClassLoader 进行类型匹配。</span>
    beanFactory.setTempClassLoader(<span class="hljs-literal">null</span>);
    <span class="hljs-comment">// 允许缓存所有 bean 定义元数据，而不是期望进一步的更改。</span>
    beanFactory.freezeConfiguration();
    <span class="hljs-comment">// 实例化所有剩余的（非惰性初始化）单例。</span>
    beanFactory.preInstantiateSingletons();					<span class="hljs-comment">//7、beanFactory的实例化已经完成，接下来实例化bean</span>
&#125;</code></pre></div>
</li>
<li><p>预实例化单例</p>
 <div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preInstantiateSingletons</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException &#123;
    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
        logger.trace(<span class="hljs-string">&quot;Pre-instantiating singletons in &quot;</span> + <span class="hljs-built_in">this</span>);
    &#125;

    <span class="hljs-comment">// 创建一个数组，里面是将要实例化的bean信息</span>
    List&lt;String&gt; beanNames = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(<span class="hljs-built_in">this</span>.beanDefinitionNames);

    <span class="hljs-comment">// 触发所有非惰性单例 bean 的初始化...</span>
    <span class="hljs-keyword">for</span> (String beanName : beanNames) &#123;
        <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">bd</span> <span class="hljs-operator">=</span> getMergedLocalBeanDefinition(beanName);
        <span class="hljs-keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;
            <span class="hljs-keyword">if</span> (isFactoryBean(beanName)) &#123;
                <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> getBean(FACTORY_BEAN_PREFIX + beanName);
                <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> FactoryBean) &#123;
                    FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;
                    <span class="hljs-type">boolean</span> isEagerInit;
                    <span class="hljs-keyword">if</span> (System.getSecurityManager() != <span class="hljs-literal">null</span> &amp;&amp; factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean) &#123;
                        isEagerInit = AccessController.doPrivileged(
                            (PrivilegedAction&lt;Boolean&gt;) ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,
                            getAccessControlContext());
                    &#125;
                    <span class="hljs-keyword">else</span> &#123;
                        isEagerInit = (factory <span class="hljs-keyword">instanceof</span> SmartFactoryBean &amp;&amp;
                                       ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());
                    &#125;
                    <span class="hljs-keyword">if</span> (isEagerInit) &#123;
                        getBean(beanName);
                    &#125;
                &#125;
            &#125;
            <span class="hljs-keyword">else</span> &#123;
                getBean(beanName);										<span class="hljs-comment">//8、得到Bean</span>
            &#125;
        &#125;
    &#125;</code></pre></div>
</li>
<li><p>使用getBean()实例化对象</p>
 <div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getBean</span><span class="hljs-params">(String name)</span> <span class="hljs-keyword">throws</span> BeansException &#123;
    <span class="hljs-keyword">return</span> doGetBean(name, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">false</span>);					<span class="hljs-comment">//9、getBean()调用doGetBean()来实际运行</span>
&#125;

<span class="hljs-comment">/**</span>
<span class="hljs-comment">* 返回指定 bean 的一个实例，该实例可以是共享的，也可以是独立的。</span>
<span class="hljs-comment">* <span class="hljs-doctag">@param</span> name 要检索的 bean 的名称</span>
<span class="hljs-comment">* <span class="hljs-doctag">@param</span> requiredType 需要检索的 bean 类型</span>
<span class="hljs-comment">* <span class="hljs-doctag">@param</span> args 使用显式参数创建 bean 实例时使用的参数（仅在创建新实例而不是检索现有实例时应用）</span>
<span class="hljs-comment">* <span class="hljs-doctag">@param</span> typeCheckOnly 是否获取实例进行类型检查，而不是实际使用</span>
<span class="hljs-comment">*/</span>
<span class="hljs-keyword">protected</span> &lt;T&gt; T <span class="hljs-title function_">doGetBean</span><span class="hljs-params">(</span>
<span class="hljs-params">    String name, <span class="hljs-meta">@Nullable</span> Class&lt;T&gt; requiredType, <span class="hljs-meta">@Nullable</span> Object[] args, <span class="hljs-type">boolean</span> typeCheckOnly)</span>
    <span class="hljs-keyword">throws</span> BeansException &#123;
    <span class="hljs-comment">//检查别名</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">beanName</span> <span class="hljs-operator">=</span> transformedBeanName(name);
    Object bean;

    <span class="hljs-comment">// 先去缓存中查询一下是否已经实例化</span>
    <span class="hljs-type">Object</span> <span class="hljs-variable">sharedInstance</span> <span class="hljs-operator">=</span> getSingleton(beanName);
    <span class="hljs-keyword">if</span> (sharedInstance != <span class="hljs-literal">null</span> &amp;&amp; args == <span class="hljs-literal">null</span>) &#123;
        <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
            <span class="hljs-keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;
                logger.trace(<span class="hljs-string">&quot;Returning eagerly cached instance of singleton bean &#x27;&quot;</span> + beanName +
                             <span class="hljs-string">&quot;&#x27; that is not fully initialized yet - a consequence of a circular reference&quot;</span>);
            &#125;
            <span class="hljs-keyword">else</span> &#123;
                logger.trace(<span class="hljs-string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);
            &#125;
        &#125;
        bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="hljs-literal">null</span>);
    &#125; <span class="hljs-keyword">else</span> &#123;
        <span class="hljs-comment">// 如果我们已经在创建这个 bean 实例则失败 抛出：BeanCurrentlyInCreationException</span>
        <span class="hljs-keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName);
        &#125;

        <span class="hljs-comment">// 检查此工厂中是否存在 bean 定义（bean是否有父子包含关系）</span>
        <span class="hljs-type">BeanFactory</span> <span class="hljs-variable">parentBeanFactory</span> <span class="hljs-operator">=</span> getParentBeanFactory();
        <span class="hljs-keyword">if</span> (parentBeanFactory != <span class="hljs-literal">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;
            <span class="hljs-comment">// Not found -&gt; check parent.</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">nameToLookup</span> <span class="hljs-operator">=</span> originalBeanName(name);
            <span class="hljs-keyword">if</span> (parentBeanFactory <span class="hljs-keyword">instanceof</span> AbstractBeanFactory) &#123;
                <span class="hljs-keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(
                    nameToLookup, requiredType, args, typeCheckOnly);
            &#125;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (args != <span class="hljs-literal">null</span>) &#123;
                <span class="hljs-comment">// Delegation to parent with explicit args.</span>
                <span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);
            &#125;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span>) &#123;
                <span class="hljs-comment">// No args -&gt; delegate to standard getBean method.</span>
                <span class="hljs-keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);
            &#125;
            <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup);
            &#125;
        &#125;

        <span class="hljs-keyword">if</span> (!typeCheckOnly) &#123;
            <span class="hljs-comment">//9、将Bean标记为已创建，接下来就要开始创建了</span>
            markBeanAsCreated(beanName);
        &#125;

        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-comment">//创建Bean，RootBeanDefinition就是在Bean容器中抽象的Bean</span>
            <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbd</span> <span class="hljs-operator">=</span> getMergedLocalBeanDefinition(beanName);
            checkMergedBeanDefinition(mbd, beanName, args);

            <span class="hljs-comment">// 保证当前 bean 所依赖的 bean 的初始化。</span>
            String[] dependsOn = mbd.getDependsOn();
            <span class="hljs-keyword">if</span> (dependsOn != <span class="hljs-literal">null</span>) &#123;		<span class="hljs-comment">//false</span>
                <span class="hljs-keyword">for</span> (String dep : dependsOn) &#123;
                    <span class="hljs-keyword">if</span> (isDependent(beanName, dep)) &#123;
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,
                                                        <span class="hljs-string">&quot;Circular depends-on relationship between &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; and &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>);
                    &#125;
                    registerDependentBean(dep, beanName);
                    <span class="hljs-keyword">try</span> &#123;
                        getBean(dep);
                    &#125;
                    <span class="hljs-keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,
                                                        <span class="hljs-string">&quot;&#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; depends on missing bean &#x27;&quot;</span> + dep + <span class="hljs-string">&quot;&#x27;&quot;</span>, ex);
                    &#125;
                &#125;
            &#125;

            <span class="hljs-comment">// 创建Bean实例</span>
            <span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;	<span class="hljs-comment">//判断是否是单例</span>
                sharedInstance = getSingleton(beanName, () -&gt; &#123;
                    <span class="hljs-keyword">try</span> &#123;
<span class="hljs-comment">//-----------------------------重点-------------------------------------------------------------</span>
                        <span class="hljs-comment">//10、创建Bean，详见注2</span>
                        <span class="hljs-keyword">return</span> createBean(beanName, mbd, args);
                    &#125;
                    <span class="hljs-keyword">catch</span> (BeansException ex) &#123;
                        <span class="hljs-comment">//从单例缓存中显式删除实例：它可能已被创建放在了eagerly缓存中，以允许循环引用解析。还要删除任何接收到对 bean 的临时引用的 bean。</span>
                        destroySingleton(beanName);
                        <span class="hljs-keyword">throw</span> ex;
                    &#125;
                &#125;);
                bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
            &#125;

            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mbd.isPrototype()) &#123;
                <span class="hljs-comment">// It&#x27;s a prototype -&gt; create a new instance.</span>
                <span class="hljs-type">Object</span> <span class="hljs-variable">prototypeInstance</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">try</span> &#123;
                    beforePrototypeCreation(beanName);
                    prototypeInstance = createBean(beanName, mbd, args);
                &#125;
                <span class="hljs-keyword">finally</span> &#123;
                    afterPrototypeCreation(beanName);
                &#125;
                bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);
            &#125;

            <span class="hljs-keyword">else</span> &#123;
                <span class="hljs-type">String</span> <span class="hljs-variable">scopeName</span> <span class="hljs-operator">=</span> mbd.getScope();
                <span class="hljs-keyword">if</span> (!StringUtils.hasLength(scopeName)) &#123;
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No scope name defined for bean ´&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);
                &#125;
                <span class="hljs-type">Scope</span> <span class="hljs-variable">scope</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.scopes.get(scopeName);
                <span class="hljs-keyword">if</span> (scope == <span class="hljs-literal">null</span>) &#123;
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27;&quot;</span>);
                &#125;
                <span class="hljs-keyword">try</span> &#123;
                    <span class="hljs-type">Object</span> <span class="hljs-variable">scopedInstance</span> <span class="hljs-operator">=</span> scope.get(beanName, () -&gt; &#123;
                        beforePrototypeCreation(beanName);
                        <span class="hljs-keyword">try</span> &#123;
                            <span class="hljs-keyword">return</span> createBean(beanName, mbd, args);
                        &#125;
                        <span class="hljs-keyword">finally</span> &#123;
                            afterPrototypeCreation(beanName);
                        &#125;
                    &#125;);
                    bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);
                &#125;
                <span class="hljs-keyword">catch</span> (IllegalStateException ex) &#123;
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(beanName,
                                                    <span class="hljs-string">&quot;Scope &#x27;&quot;</span> + scopeName + <span class="hljs-string">&quot;&#x27; is not active for the current thread; consider &quot;</span> +
                                                    <span class="hljs-string">&quot;defining a scoped proxy for this bean if you intend to refer to it from a singleton&quot;</span>,
                                                    ex);
                &#125;
            &#125;
        &#125;
        <span class="hljs-keyword">catch</span> (BeansException ex) &#123;
            cleanupAfterBeanCreationFailure(beanName);
            <span class="hljs-keyword">throw</span> ex;
        &#125;
    &#125;

    <span class="hljs-comment">// Check if required type matches the type of the actual bean instance.</span>
    <span class="hljs-keyword">if</span> (requiredType != <span class="hljs-literal">null</span> &amp;&amp; !requiredType.isInstance(bean)) &#123;
        <span class="hljs-keyword">try</span> &#123;
            <span class="hljs-type">T</span> <span class="hljs-variable">convertedBean</span> <span class="hljs-operator">=</span> getTypeConverter().convertIfNecessary(bean, requiredType);
            <span class="hljs-keyword">if</span> (convertedBean == <span class="hljs-literal">null</span>) &#123;
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());
            &#125;
            <span class="hljs-keyword">return</span> convertedBean;
        &#125;
        <span class="hljs-keyword">catch</span> (TypeMismatchException ex) &#123;
            <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
                logger.trace(<span class="hljs-string">&quot;Failed to convert bean &#x27;&quot;</span> + name + <span class="hljs-string">&quot;&#x27; to required type &#x27;&quot;</span> +
                             ClassUtils.getQualifiedName(requiredType) + <span class="hljs-string">&quot;&#x27;&quot;</span>, ex);
            &#125;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());
        &#125;
    &#125;
    <span class="hljs-keyword">return</span> (T) bean;
&#125;</code></pre></div>

</li>
<li><p>6</p>
</li>
<li><p>7</p>
</li>
</ol>
<h2 id="注"><a href="#注" class="headerlink" title="注"></a>注</h2><h4 id="注1："><a href="#注1：" class="headerlink" title="注1："></a>注1：</h4><p>这段代码是为了去一级缓存中查询一下Bean对象是否在一级缓存中，或者是否已经创建但未完成注入。&#x3D;&#x3D;&gt;结果是null</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-meta">@Override</span>
<span class="hljs-meta">@Nullable</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getSingleton</span><span class="hljs-params">(String beanName)</span> &#123;
    <span class="hljs-keyword">return</span> getSingleton(beanName, <span class="hljs-literal">true</span>);
&#125;

<span class="hljs-comment">/**</span>
<span class="hljs-comment">* 返回在给定名称下注册的（原始）单例对象。</span>
<span class="hljs-comment">* 检查已经实例化的单例，还允许对当前创建的单例进行早期引用（解决循环引用）。</span>
<span class="hljs-comment">*/</span>
<span class="hljs-meta">@Nullable</span>
<span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">getSingleton</span><span class="hljs-params">(String beanName, <span class="hljs-type">boolean</span> allowEarlyReference)</span> &#123;
    <span class="hljs-comment">// 快速检查没有完整实例化的现有实例</span>
    <span class="hljs-comment">// 首先从singletonObjects（一级缓存）中查找</span>
    <span class="hljs-type">Object</span> <span class="hljs-variable">singletonObject</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);
    <span class="hljs-comment">//如果已经实例化但未完成注入则继续。</span>
    <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; isSingletonCurrentlyInCreation(beanName)) &#123;		<span class="hljs-comment">//false</span>
        <span class="hljs-comment">// 如果一级缓存中没有再去二级缓存中查找</span>
        singletonObject = <span class="hljs-built_in">this</span>.earlySingletonObjects.get(beanName);
        <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span> &amp;&amp; allowEarlyReference) &#123;
            <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>.singletonObjects) &#123;
                <span class="hljs-comment">// 在完整的单例锁中一致地创建早期引用</span>
                singletonObject = <span class="hljs-built_in">this</span>.singletonObjects.get(beanName);
                <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;
                    singletonObject = <span class="hljs-built_in">this</span>.earlySingletonObjects.get(beanName);
                    <span class="hljs-keyword">if</span> (singletonObject == <span class="hljs-literal">null</span>) &#123;
                        ObjectFactory&lt;?&gt; singletonFactory = <span class="hljs-built_in">this</span>.singletonFactories.get(beanName);
                        <span class="hljs-keyword">if</span> (singletonFactory != <span class="hljs-literal">null</span>) &#123;
                            singletonObject = singletonFactory.getObject();
                            <span class="hljs-built_in">this</span>.earlySingletonObjects.put(beanName, singletonObject);
                            <span class="hljs-built_in">this</span>.singletonFactories.remove(beanName);
                        &#125;
                    &#125;
                &#125;
            &#125;
        &#125;
    &#125;
    <span class="hljs-keyword">return</span> singletonObject;
&#125;</code></pre></div>

<h4 id="注2："><a href="#注2：" class="headerlink" title="注2："></a>注2：</h4><p>此类的中心方法：创建 bean 实例、填充 bean 实例、应用后处理器等。</p>
<div class="code-wrapper"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">createBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span>
    <span class="hljs-keyword">throws</span> BeanCreationException &#123;

    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
        logger.trace(<span class="hljs-string">&quot;Creating instance of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);
    &#125;
    <span class="hljs-type">RootBeanDefinition</span> <span class="hljs-variable">mbdToUse</span> <span class="hljs-operator">=</span> mbd;

    <span class="hljs-comment">//解析Ben：确保此时实际解析了 bean 类，并克隆 bean 定义以防动态解析的 Class 无法存储在共享的合并 bean 定义中。</span>
    Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);
    <span class="hljs-keyword">if</span> (resolvedClass != <span class="hljs-literal">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="hljs-literal">null</span>) &#123;
        mbdToUse = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RootBeanDefinition</span>(mbd);
        mbdToUse.setBeanClass(resolvedClass);
    &#125;

    <span class="hljs-comment">// Prepare method overrides.</span>
    <span class="hljs-keyword">try</span> &#123;
        mbdToUse.prepareMethodOverrides();
    &#125;
    <span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanDefinitionStoreException</span>(mbdToUse.getResourceDescription(),
                                               beanName, <span class="hljs-string">&quot;Validation of method overrides failed&quot;</span>, ex);
    &#125;

    <span class="hljs-keyword">try</span> &#123;
        <span class="hljs-comment">// Give BeanPostProcessors a chance to return a proxy instead of the target bean instance.</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> resolveBeforeInstantiation(beanName, mbdToUse);
        <span class="hljs-keyword">if</span> (bean != <span class="hljs-literal">null</span>) &#123;
            <span class="hljs-keyword">return</span> bean;
        &#125;
    &#125;
    <span class="hljs-keyword">catch</span> (Throwable ex) &#123;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbdToUse.getResourceDescription(), beanName,
                                        <span class="hljs-string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span>, ex);
    &#125;

    <span class="hljs-keyword">try</span> &#123;
<span class="hljs-comment">//---------------------------------------重点-------------------------------------------------------</span>
        <span class="hljs-comment">//创建Ben</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">beanInstance</span> <span class="hljs-operator">=</span> doCreateBean(beanName, mbdToUse, args);
        <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
            logger.trace(<span class="hljs-string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27;&quot;</span>);
        &#125;
        <span class="hljs-keyword">return</span> beanInstance;
    &#125;
    <span class="hljs-keyword">catch</span> (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;
        <span class="hljs-comment">// A previously detected exception with proper bean creation context already,</span>
        <span class="hljs-comment">// or illegal singleton state to be communicated up to DefaultSingletonBeanRegistry.</span>
        <span class="hljs-keyword">throw</span> ex;
    &#125;
    <span class="hljs-keyword">catch</span> (Throwable ex) &#123;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(
            mbdToUse.getResourceDescription(), beanName, <span class="hljs-string">&quot;Unexpected exception during bean creation&quot;</span>, ex);
    &#125;
&#125;



<span class="hljs-comment">//实际创建指定Bean</span>
<span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">doCreateBean</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span>
			<span class="hljs-keyword">throws</span> BeanCreationException &#123;

		<span class="hljs-comment">// Instantiate the bean.</span>
		<span class="hljs-type">BeanWrapper</span> <span class="hljs-variable">instanceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
		<span class="hljs-keyword">if</span> (mbd.isSingleton()) &#123;
			instanceWrapper = <span class="hljs-built_in">this</span>.factoryBeanInstanceCache.remove(beanName);
		&#125;
		<span class="hljs-keyword">if</span> (instanceWrapper == <span class="hljs-literal">null</span>) &#123;
<span class="hljs-comment">//-------------------重点-------------------------------------------------------------------------</span>
            <span class="hljs-comment">//创建Bean实例</span>
			instanceWrapper = createBeanInstance(beanName, mbd, args);
		&#125;
		<span class="hljs-type">Object</span> <span class="hljs-variable">bean</span> <span class="hljs-operator">=</span> instanceWrapper.getWrappedInstance();
		Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();
		<span class="hljs-keyword">if</span> (beanType != NullBean.class) &#123;
			mbd.resolvedTargetType = beanType;
		&#125;

		<span class="hljs-comment">// Allow post-processors to modify the merged bean definition.</span>
		<span class="hljs-keyword">synchronized</span> (mbd.postProcessingLock) &#123;
			<span class="hljs-keyword">if</span> (!mbd.postProcessed) &#123;
				<span class="hljs-keyword">try</span> &#123;
					applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);
				&#125;
				<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
					<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,
							<span class="hljs-string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);
				&#125;
				mbd.postProcessed = <span class="hljs-literal">true</span>;
			&#125;
		&#125;

		<span class="hljs-comment">// Eagerly cache singletons to be able to resolve circular references</span>
		<span class="hljs-comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span>
		<span class="hljs-type">boolean</span> <span class="hljs-variable">earlySingletonExposure</span> <span class="hljs-operator">=</span> (mbd.isSingleton() &amp;&amp; <span class="hljs-built_in">this</span>.allowCircularReferences &amp;&amp;
				isSingletonCurrentlyInCreation(beanName));
		<span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;
			<span class="hljs-keyword">if</span> (logger.isTraceEnabled()) &#123;
				logger.trace(<span class="hljs-string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +
						<span class="hljs-string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);
			&#125;
			addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));
		&#125;

		<span class="hljs-comment">// Initialize the bean instance.</span>
		<span class="hljs-type">Object</span> <span class="hljs-variable">exposedObject</span> <span class="hljs-operator">=</span> bean;
		<span class="hljs-keyword">try</span> &#123;
			populateBean(beanName, mbd, instanceWrapper);
			exposedObject = initializeBean(beanName, exposedObject, mbd);
		&#125;
		<span class="hljs-keyword">catch</span> (Throwable ex) &#123;
			<span class="hljs-keyword">if</span> (ex <span class="hljs-keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;
				<span class="hljs-keyword">throw</span> (BeanCreationException) ex;
			&#125;
			<span class="hljs-keyword">else</span> &#123;
				<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(
						mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Initialization of bean failed&quot;</span>, ex);
			&#125;
		&#125;

		<span class="hljs-keyword">if</span> (earlySingletonExposure) &#123;
			<span class="hljs-type">Object</span> <span class="hljs-variable">earlySingletonReference</span> <span class="hljs-operator">=</span> getSingleton(beanName, <span class="hljs-literal">false</span>);
			<span class="hljs-keyword">if</span> (earlySingletonReference != <span class="hljs-literal">null</span>) &#123;
				<span class="hljs-keyword">if</span> (exposedObject == bean) &#123;
					exposedObject = earlySingletonReference;
				&#125;
				<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;
					String[] dependentBeans = getDependentBeans(beanName);
					Set&lt;String&gt; actualDependentBeans = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>&lt;&gt;(dependentBeans.length);
					<span class="hljs-keyword">for</span> (String dependentBean : dependentBeans) &#123;
						<span class="hljs-keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;
							actualDependentBeans.add(dependentBean);
						&#125;
					&#125;
					<span class="hljs-keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;
						<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCurrentlyInCreationException</span>(beanName,
								<span class="hljs-string">&quot;Bean with name &#x27;&quot;</span> + beanName + <span class="hljs-string">&quot;&#x27; has been injected into other beans [&quot;</span> +
								StringUtils.collectionToCommaDelimitedString(actualDependentBeans) +
								<span class="hljs-string">&quot;] in its raw version as part of a circular reference, but has eventually been &quot;</span> +
								<span class="hljs-string">&quot;wrapped. This means that said other beans do not use the final version of the &quot;</span> +
								<span class="hljs-string">&quot;bean. This is often the result of over-eager type matching - consider using &quot;</span> +
								<span class="hljs-string">&quot;&#x27;getBeanNamesForType&#x27; with the &#x27;allowEagerInit&#x27; flag turned off, for example.&quot;</span>);
					&#125;
				&#125;
			&#125;
		&#125;

		<span class="hljs-comment">// Register bean as disposable.</span>
		<span class="hljs-keyword">try</span> &#123;
			registerDisposableBeanIfNecessary(beanName, bean, mbd);
		&#125;
		<span class="hljs-keyword">catch</span> (BeanDefinitionValidationException ex) &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(
					mbd.getResourceDescription(), beanName, <span class="hljs-string">&quot;Invalid destruction signature&quot;</span>, ex);
		&#125;

		<span class="hljs-keyword">return</span> exposedObject;
	&#125;

<span class="hljs-comment">//选择适当策略为指定Bean生成一个实例</span>
<span class="hljs-keyword">protected</span> BeanWrapper <span class="hljs-title function_">createBeanInstance</span><span class="hljs-params">(String beanName, RootBeanDefinition mbd, <span class="hljs-meta">@Nullable</span> Object[] args)</span> &#123;
		<span class="hljs-comment">// 确保此时实际解析了 bean 类。</span>
		Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);

		<span class="hljs-keyword">if</span> (beanClass != <span class="hljs-literal">null</span> &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;
			<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,
					<span class="hljs-string">&quot;Bean class isn&#x27;t public, and non-public access not allowed: &quot;</span> + beanClass.getName());
		&#125;

		Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();
		<span class="hljs-keyword">if</span> (instanceSupplier != <span class="hljs-literal">null</span>) &#123;
			<span class="hljs-keyword">return</span> obtainFromSupplier(instanceSupplier, beanName);
		&#125;

		<span class="hljs-keyword">if</span> (mbd.getFactoryMethodName() != <span class="hljs-literal">null</span>) &#123;
			<span class="hljs-keyword">return</span> instantiateUsingFactoryMethod(beanName, mbd, args);
		&#125;

		<span class="hljs-comment">// Shortcut when re-creating the same bean...</span>
		<span class="hljs-type">boolean</span> <span class="hljs-variable">resolved</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
		<span class="hljs-type">boolean</span> <span class="hljs-variable">autowireNecessary</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
		<span class="hljs-keyword">if</span> (args == <span class="hljs-literal">null</span>) &#123;
			<span class="hljs-keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;
				<span class="hljs-keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="hljs-literal">null</span>) &#123;
					resolved = <span class="hljs-literal">true</span>;
					autowireNecessary = mbd.constructorArgumentsResolved;
				&#125;
			&#125;
		&#125;
		<span class="hljs-keyword">if</span> (resolved) &#123;
			<span class="hljs-keyword">if</span> (autowireNecessary) &#123;
				<span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);
			&#125;
			<span class="hljs-keyword">else</span> &#123;
				<span class="hljs-keyword">return</span> instantiateBean(beanName, mbd);
			&#125;
		&#125;

		<span class="hljs-comment">// Candidate constructors for autowiring?</span>
		Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);
		<span class="hljs-keyword">if</span> (ctors != <span class="hljs-literal">null</span> || mbd.getResolvedAutowireMode() == AUTOWIRE_CONSTRUCTOR ||
				mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args)) &#123;
			<span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);
		&#125;

		<span class="hljs-comment">// Preferred constructors for default construction?</span>
		ctors = mbd.getPreferredConstructors();
		<span class="hljs-keyword">if</span> (ctors != <span class="hljs-literal">null</span>) &#123;
			<span class="hljs-keyword">return</span> autowireConstructor(beanName, mbd, ctors, <span class="hljs-literal">null</span>);
		&#125;

		<span class="hljs-comment">// No special handling: simply use no-arg constructor.</span>
		<span class="hljs-keyword">return</span> instantiateBean(beanName, mbd);
	&#125;</code></pre></div>





<h2 id="大致流程图"><a href="#大致流程图" class="headerlink" title="大致流程图"></a>大致流程图</h2><p><img src="/2022/09/06/spring/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/Bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/20201212215421213.png" srcset="/img/loading.gif" lazyload alt="简单流程图"></p>
<h2 id="详细流程图"><a href="#详细流程图" class="headerlink" title="详细流程图"></a>详细流程图</h2><img src="20201212215520379.png" srcset="/img/loading.gif" lazyload alt="详细流程图"  />
                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Spring/" class="category-chain-item">Spring</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%BA%90%E7%A0%81/">#源码</a>
      
        <a href="/tags/Spring/">#Spring</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Spring Bean注入详解</div>
      <div>https://ww-ccw.github.io/2022/09/06/spring/Bean生命周期/Bean生命周期/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>chw</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年9月6日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/11/05/juc/Synchronized%E5%92%8CReentrantReadWriteLock/" title="浅析锁机制">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">浅析锁机制</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/07/22/pay/zfbpay/" title="集成支付宝支付流程">
                        <span class="hidden-mobile">集成支付宝支付流程</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
